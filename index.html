<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>3-D Lottery</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
    #scene{position:absolute;top:0;left:0;width:100%;height:100%}
    #winnerBanner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:4rem;text-shadow:0 0 10px #fff;display:none}
    #adminToggle{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);font-size:24px;cursor:pointer;z-index:999}
    #adminPanel{position:fixed;bottom:0;left:0;right:0;background:#111;transition:height .3s;height:40px;overflow:hidden}
    #adminPanel.expanded{height:220px}
    .tabs{display:flex;background:#222}
    .tab{background:#333;border:none;color:#fff;padding:8px 16px;cursor:pointer;font-size:14px}
    .tab.active{background:#0078d4}
    .tabContent{padding:12px;display:none}
    .tabContent.active{display:block}
    button{cursor:pointer;padding:6px 12px;margin-right:6px}
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r154/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

  <div id="scene"></div>
  <div id="winnerBanner">
    <h1>Winner: <span id="winnerNo"></span></h1>
  </div>

  <div id="adminToggle">▲</div>
  <div id="adminPanel" class="collapsed">
    <div class="tabs">
      <button class="tab active" data-tab="controls">Lottery Controls</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>

    <div id="controls" class="tabContent active">
      <button id="drawBtn" disabled>Draw</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div id="settings" class="tabContent">
      <input type="file" id="excelFile" accept=".xlsx"/>
      <input type="password" id="adminPass" placeholder="Admin password"/>
      <button id="uploadBtn">Upload & Replace</button>
    </div>
  </div>

  <audio id="spinSound" src="https://cdn.jsdelivr.net/gh/fireship-io/threejs-scroll-animation-demo@main/spin.mp3" preload="auto"></audio>
  <audio id="winSound"  src="https://cdn.jsdelivr.net/gh/fireship-io/threejs-scroll-animation-demo@main/win.mp3"  preload="auto"></audio>

  <script>
  /* === FIREBASE CONFIG === */
 const firebaseConfig = {
            apiKey: "AIzaSyAMt0b4VerCgr6wj2K2Ago_UtgpzODEb4I",
            authDomain: "ykko-staffparty-goodbye-ksd.firebaseapp.com",
            projectId: "ykko-staffparty-goodbye-ksd",
            storageBucket: "ykko-staffparty-goodbye-ksd.firebasestorage.app",
            messagingSenderId: "393329904546",
            appId: "1:393329904546:web:3751bc73e8d0505d4140fb",
            measurementId: "G-W0RSQX8XJ8"
        };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.database(), dbRef=db.ref('lottery');

  /* === THREE.JS === */
  const scene=new THREE.Scene(), camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1000);
  camera.position.set(0,0,60);
  const renderer=new THREE.WebGLRenderer({alpha:true}); renderer.setSize(innerWidth,innerHeight);
  document.getElementById('scene').appendChild(renderer.domElement);
  scene.add(new THREE.AmbientLight(0xffffff,.7));
  const dir=new THREE.DirectionalLight(0xffffff,.7); dir.position.set(5,10,7); scene.add(dir);

  const ROWS=7, COLS=25, TOTAL=ROWS*COLS;
  const cardGeo=new THREE.PlaneGeometry(1.8,1);
  const canvas=document.createElement('canvas'); canvas.width=256; canvas.height=128; const ctx=canvas.getContext('2d');
  function makeTexture(num){
    ctx.fillStyle='#000'; ctx.fillRect(0,0,256,128);
    ctx.fillStyle='#fff'; ctx.font='bold 80px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(num,128,64); return new THREE.CanvasTexture(canvas);
  }
  const group=new THREE.Group(); const cards=[];
  for(let i=0;i<TOTAL;i++){
    const mat=new THREE.MeshBasicMaterial({map:makeTexture(i+1),transparent:true});
    const mesh=new THREE.Mesh(cardGeo,mat);
    const r=Math.floor(i/COLS), c=i%COLS;
    mesh.position.set(c-COLS/2, ROWS/2-r, 0);
    group.add(mesh); cards.push(mesh);
  }
  scene.add(group);

  /* === REAL-TIME DATA === */
  let participants=[], winners=new Set();
  dbRef.child('participants').on('value', s=>{ participants=s.val()||[] });
  dbRef.child('winners').on('value', s=>{ winners=new Set(s.val()||[]) });
  dbRef.child('state').on('value', s=>{
    const st=s.val()||{phase:'idle'};
    if(st.phase==='spinning') startSpin();
    else if(st.phase==='won') revealWinner(st.winner);
    else resetView();
  });

  /* === DRAWING LOGIC === */
  function startSpin(){
    document.getElementById('spinSound').play();
    const radius=14;
    cards.forEach((card,i)=>{
      const phi=Math.acos(-1+(2*i)/TOTAL), theta=Math.sqrt(TOTAL*Math.PI)*phi;
      const target=new THREE.Vector3(radius*Math.cos(theta)*Math.sin(phi),radius*Math.sin(theta)*Math.sin(phi),radius*Math.cos(phi));
      new TWEEN.Tween(card.position).to(target,2000).easing(TWEEN.Easing.Quadratic.Out).start();
    });
    const dur=7000+Math.random()*8000, start=Date.now();
    function spin(){ group.rotation.y+=0.03; if(Date.now()-start<dur) requestAnimationFrame(spin); else dbRef.child('state').update({phase:'won'}); }
    spin();
  }
  function revealWinner(num){
    document.getElementById('winSound').play();
    const idx=Math.floor(Math.random()*TOTAL);
    cards[idx].material.map=makeTexture(num); cards[idx].material.needsUpdate=true;
    new TWEEN.Tween(camera.position).to({z:30},1000).start();
    document.getElementById('winnerNo').textContent=num;
    document.getElementById('winnerBanner').style.display='block';
  }
  function resetView(){
    document.getElementById('winnerBanner').style.display='none';
    document.getElementById('spinSound').pause(); document.getElementById('winSound').pause();
    cards.forEach((card,i)=>{
      const r=Math.floor(i/COLS), c=i%COLS;
      const pos=new THREE.Vector3(c-COLS/2, ROWS/2-r, 0);
      new TWEEN.Tween(card.position).to(pos,1000).start();
    });
    new TWEEN.Tween(camera.position).to({z:60},1000).start();
    cards.forEach(c=>{ c.material.map=makeTexture(Math.floor(Math.random()*9999)); c.material.needsUpdate=true; });
  }

  /* === ADMIN PANEL === */
  const toggle=document.getElementById('adminToggle'), panel=document.getElementById('adminPanel');
  toggle.onclick=()=>{ panel.classList.toggle('collapsed'); panel.classList.toggle('expanded'); toggle.textContent=panel.classList.contains('expanded')?'▼':'▲'; };
  document.querySelectorAll('.tab').forEach(btn=>btn.onclick=e=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tabContent').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active'); document.getElementById(btn.dataset.tab).classList.add('active');
  });

  const drawBtn=document.getElementById('drawBtn'), resetBtn=document.getElementById('resetBtn');
  drawBtn.onclick=()=>{
    const pool=participants.filter(p=>!winners.has(p));
    if(!pool.length){alert('No more participants');return;}
    const winner=pool[Math.floor(Math.random()*pool.length)];
    dbRef.child('state').set({phase:'spinning'});
    setTimeout(()=>dbRef.child('state').set({phase:'won', winner}), 7000+Math.random()*8000);
    dbRef.child('winners').push(winner);
  };
  resetBtn.onclick=()=>{ if(confirm('Reset all?')) dbRef.set({participants:[], state:{phase:'idle'}, winners:[]}); };

  document.getElementById('uploadBtn').onclick=()=>{
    const pass=document.getElementById('adminPass').value;
    if(pass!=='iloveyou!@#$%'){alert('Wrong password');return;}
    const file=document.getElementById('excelFile').files[0];
    if(!file){alert('Choose file');return;}
    const reader=new FileReader();
    reader.onload=e=>{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const nums=XLSX.utils.sheet_to_json(ws,{header:1}).flat().filter(v=>!isNaN(v)).map(Number);
      if(nums.length<5000){alert('Need ≥5000 numbers');return;}
      dbRef.set({participants:nums, state:{phase:'idle'}, winners:[]});
      alert('Updated!');
    };
    reader.readAsBinaryString(file);
  };
  dbRef.child('state').on('value', s=>{ drawBtn.disabled=((s.val()||{}).phase!=='idle'); });

  /* === RENDER LOOP === */
  function animate(){ requestAnimationFrame(animate); TWEEN.update(); renderer.render(scene,camera); }
  animate();
  window.addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
  </script>
</body>
</html>
